<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏©‡∏µ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js" async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: 'Tahoma', 'Sarabun', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.6; }
        body { display: flex; flex-direction: column; padding: 10px; }
        .container { width: 100%; max-width: 100%; flex-grow: 1; display: flex; flex-direction: column; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-y: auto; }
        h1, h2 { color: #2c3e50; text-align: center; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 6px; font-weight: bold; color: #555; }
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; width: 100%; }
        .branch-options { display: flex; align-items: center; flex-wrap: wrap; }
        .branch-options label { margin-right: 10px; margin-bottom: 0; font-weight: normal; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .form-actions button, .delete-btn, .action-btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; color: white; transition: background-color 0.3s ease; }
        .form-actions button[type="submit"] { background-color: #5cb85c; }
        .form-actions button[type="submit"]:hover { background-color: #4cae4c; }
        .form-actions button[type="reset"] { background-color: #f0ad4e; }
        .form-actions button[type="reset"]:hover { background-color: #ec971f; }
        .delete-btn { background-color: #d9534f; padding: 5px 10px; font-size: 0.8em; }
        .delete-btn:hover { background-color: #c9302c; }
        .data-table-container { margin-top: 25px; overflow-x: auto; flex-grow: 1; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.85em; }
        .data-table th { background-color: #e9ecef; position: sticky; top: 0; z-index: 1; }
        .data-table tbody { display: block; max-height: 400px; overflow-y: auto; }
        .data-table thead, .data-table tbody tr { display: table; width: 100%; table-layout: fixed; }
        .data-table tr:nth-child(even) { background-color: #f8f9fa; }
        .data-table .actions-column { width: 80px; text-align: center; }
        .form-group { position: relative; }
        div.awesomplete > ul { position: absolute; background-color: white; border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 2px; width: 100%; z-index: 9999; }

        /* === CSS ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ === */
        .floating-btn {
            position: fixed;
            padding: 12px 24px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            z-index: 1000;
            transition: transform 0.2s ease-in-out;
        }
        .floating-btn:hover {
            transform: scale(1.05);
        }
        #historyFloatingBtn {
            top: 20px;
            right: 20px;
        }
        #saveFloatingBtn {
            bottom: 20px;
            right: 20px;
            text-transform: uppercase;
        }
        .modal-overlay {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .modal-close-btn:hover {
            color: #333;
        }
        .history-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .history-controls select {
             flex-grow: 1;
             padding: 8px;
             border-radius: 4px;
             border: 1px solid #ccc;
        }
        .history-controls button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            background-color: #d9534f;
        }
    </style>
</head>
<body>

    <button id="historyFloatingBtn" class="floating-btn">history</button>
    <button id="saveFloatingBtn" class="floating-btn">save</button>

    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <span id="closeModalBtn" class="modal-close-btn">&times;</span>
            <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
            <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</p>
            <div class="history-controls">
                <select id="historySelector">
                    <option value="">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‚Äî</option>
                </select>
                <button id="deleteHistoryBtn">‡∏•‡∏ö</button>
            </div>
        </div>
    </div>
    <div class="container">
        <h1>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏©‡∏µ</h1>

        <form id="taxDataForm">
            <div class="form-grid">
                <div class="form-group"><label for="sequence">‡∏•‡∏≥‡∏î‡∏±‡∏ö (No.):</label><input type="number" id="sequence" name="sequence" readonly></div>
                <div class="form-group"><label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date):</label><input type="date" id="date" name="date" required></div>
                <div class="form-group"><label for="documentNumber">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Doc No.):</label><input type="text" id="documentNumber" name="documentNumber"></div>
                <div class="form-group"><label for="companyName">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (Company Name):</label><input type="text" id="companyName" name="companyName" required autocomplete="off" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."></div>
                <div class="form-group"><label for="taxId">‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏©‡∏µ (Tax ID):</label><input type="text" id="taxId" name="taxId" pattern="\d{13}"></div>
                <div class="form-group">
                    <label>‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Branch Type):</label>
                    <div class="branch-options">
                        <input type="radio" id="branchHeadOffice" name="branchType" value="‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà" checked>
                        <label for="branchHeadOffice">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà</label>
                        <input type="radio" id="branchSub" name="branchType" value="‡∏™‡∏≤‡∏Ç‡∏≤">
                        <label for="branchSub">‡∏™‡∏≤‡∏Ç‡∏≤</label>
                    </div>
                    <input type="text" id="branchNumber" name="branchNumber" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" style="margin-top: 5px; display: none;">
                </div>
                <div class="form-group"><label for="productPrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏Å‡πà‡∏≠‡∏ô VAT):</label><input type="number" id="productPrice" name="productPrice" step="0.01" required></div>
                <div class="form-group"><label for="vatAmount">‡∏†‡∏≤‡∏©‡∏µ (VAT):</label><input type="number" id="vatAmount" name="vatAmount" step="0.01"></div>
                <div class="form-group"><label for="totalPrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</label><input type="number" id="totalPrice" name="totalPrice" step="0.01" required></div>
            </div>
            <div class="form-actions">
                <button type="reset">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button type="submit">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
            
                <label for="loadDataInput" class="action-btn" style="background-color: #5bc0de; padding: 10px 20px; border-radius: 4px; cursor: pointer; color: white;">üìÇ ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                <input type="file" id="loadDataInput" accept=".json" style="display: none;">
                <button type="button" id="exportCsvBtn" class="action-btn" style="background-color: #2b823d;">üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel (CSV)</button>
                <button type="button" id="exportPdfBtn" class="action-btn" style="background-color: #c12e2a;">üìï ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button>
                <button type="button" onclick="window.print()" class="action-btn" style="background-color: #777;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå / ‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
            </div>
        </form>

        <div class="data-table-container">
            <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h2>
            <table class="data-table" id="taxDataTable">
                <thead>
                    <tr>
                        <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th><th>‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏©‡∏µ</th>
                        <th>‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th><th>‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏†‡∏≤‡∏©‡∏µ</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</th>
                        <th class="actions-column">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- ELEMENT SELECTORS (‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    const taxDataForm = document.getElementById('taxDataForm');
    const dataTableBody = document.querySelector('#taxDataTable tbody');
    const sequenceInput = document.getElementById('sequence');
    const companyNameInput = document.getElementById('companyName');
    const taxIdInput = document.getElementById('taxId');
    const branchHeadOfficeRadio = document.getElementById('branchHeadOffice');
    const branchSubRadio = document.getElementById('branchSub');
    const branchNumberInput = document.getElementById('branchNumber');
    const productPriceInput = document.getElementById('productPrice');
    const vatAmountInput = document.getElementById('vatAmount');
    const totalPriceInput = document.getElementById('totalPrice');

    let companyCache = [];
    let currentSequence = 1;

    // --- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
    // ... (‡πÇ‡∏Ñ‡πâ‡∏î fetchCompanyData, initializeAutocomplete ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ) ...
    async function fetchCompanyData() {
        try {
            const response = await fetch('http://127.0.0.1:5000/api/companies');
            if (!response.ok) throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÑ‡∏î‡πâ');
            companyCache = await response.json();
            initializeAutocomplete();
        } catch (error) {
            console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ï‡∏≠‡∏ô Fetch:", error);
            companyNameInput.placeholder = "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ";
        }
    }

    function initializeAutocomplete() {
        const companyList = companyCache.map(c => ({
            label: `${c.CompanyName} (${c.TaxID})`,
            value: c.CompanyName
        }));

        new Awesomplete(companyNameInput, {
            list: companyList,
            minChars: 1,
            maxItems: 10,
            filter: function(text, input) {
                return Awesomplete.FILTER_CONTAINS(text, input.match(/[^,]*$/)[0]);
            },
            sort: false
        });

        companyNameInput.addEventListener('awesomplete-selectcomplete', function(event) {
            const selectedCompanyName = event.text.value;
            const selectedCompanyObject = companyCache.find(
                company => company.CompanyName === selectedCompanyName
            );
            if (selectedCompanyObject) {
                taxIdInput.value = selectedCompanyObject.TaxID;
                if (selectedCompanyObject.BranchType && selectedCompanyObject.BranchType.includes('‡∏™‡∏≤‡∏Ç‡∏≤')) {
                    branchSubRadio.checked = true;
                    branchNumberInput.value = selectedCompanyObject.BranchNo || '';
                } else {
                    branchHeadOfficeRadio.checked = true;
                    branchNumberInput.value = '';
                }
                toggleBranchNumberInput();
            }
        });
    }
    
    function updateSequence() { const rowCount = dataTableBody.rows.length; currentSequence = rowCount + 1; sequenceInput.value = currentSequence; const rows = dataTableBody.querySelectorAll('tr'); rows.forEach((row, index) => { row.cells[0].textContent = index + 1; }); }
    function toggleBranchNumberInput() { branchNumberInput.style.display = branchSubRadio.checked ? 'block' : 'none'; if (!branchSubRadio.checked) branchNumberInput.value = ''; }
    branchSubRadio.addEventListener('change', toggleBranchNumberInput); branchHeadOfficeRadio.addEventListener('change', toggleBranchNumberInput);
    const vatRate = 0.07;
    function calculateFromPrice() { const price = parseFloat(productPriceInput.value) || 0; const vat = parseFloat((price * vatRate).toFixed(2)); vatAmountInput.value = vat; totalPriceInput.value = (price + vat).toFixed(2); }
    function calculateFromVAT() { const vat = parseFloat(vatAmountInput.value) || 0; const price = parseFloat(productPriceInput.value) || 0; if (price > 0) { totalPriceInput.value = (price + vat).toFixed(2); } else if (vat > 0 && vatRate > 0) { const calculatedPrice = parseFloat((vat / vatRate).toFixed(2)); productPriceInput.value = calculatedPrice; totalPriceInput.value = (calculatedPrice + vat).toFixed(2); } }
    productPriceInput.addEventListener('input', calculateFromPrice); vatAmountInput.addEventListener('input', calculateFromVAT);
    taxDataForm.addEventListener('submit', function (event) { event.preventDefault(); const data = new FormData(taxDataForm); const newRow = dataTableBody.insertRow(); newRow.innerHTML = `<td>${currentSequence}</td><td>${data.get('date')}</td><td>${data.get('documentNumber')}</td><td>${data.get('companyName')}</td><td>${data.get('taxId')}</td><td>${data.get('branchType')}</td><td>${data.get('branchType') === '‡∏™‡∏≤‡∏Ç‡∏≤' ? data.get('branchNumber') : '-'}</td><td>${parseFloat(data.get('productPrice')).toFixed(2)}</td><td>${parseFloat(data.get('vatAmount')).toFixed(2)}</td><td>${parseFloat(data.get('totalPrice')).toFixed(2)}</td><td class="actions-column"><button type="button" class="delete-btn">‡∏•‡∏ö</button></td>`; newRow.querySelector('.delete-btn').addEventListener('click', function() { if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) { newRow.remove(); updateSequence(); } }); taxDataForm.reset(); updateSequence(); toggleBranchNumberInput(); document.getElementById('date').focus(); });
    taxDataForm.addEventListener('reset', function() { setTimeout(() => { toggleBranchNumberInput(); updateSequence(); }, 0); });

    fetchCompanyData(); 
    updateSequence();
    toggleBranchNumberInput();
    document.getElementById('date').focus();

    // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞ Export (‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const loadDataInput = document.getElementById('loadDataInput');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');

    function getTableData() {
        const data = [];
        const rows = dataTableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = {
                sequence: cells[0].textContent,
                date: cells[1].textContent,
                documentNumber: cells[2].textContent,
                companyName: cells[3].textContent,
                taxId: cells[4].textContent,
                branchType: cells[5].textContent,
                branchNumber: cells[6].textContent,
                productPrice: cells[7].textContent,
                vatAmount: cells[8].textContent,
                totalPrice: cells[9].textContent,
            };
            data.push(rowData);
        });
        return data;
    }

    function populateTable(data) {
        dataTableBody.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
        data.forEach(item => {
            const newRow = dataTableBody.insertRow();
            newRow.innerHTML = `<td>${item.sequence}</td><td>${item.date}</td><td>${item.documentNumber}</td><td>${item.companyName}</td><td>${item.taxId}</td><td>${item.branchType}</td><td>${item.branchNumber}</td><td>${parseFloat(item.productPrice).toFixed(2)}</td><td>${parseFloat(item.vatAmount).toFixed(2)}</td><td>${parseFloat(item.totalPrice).toFixed(2)}</td><td class="actions-column"><button type="button" class="delete-btn">‡∏•‡∏ö</button></td>`;
            newRow.querySelector('.delete-btn').addEventListener('click', function() {
                if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                    newRow.remove();
                    updateSequence();
                }
            });
        });
        updateSequence();
    }

    // Event Listeners ‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Import/Export
    loadDataInput.addEventListener('change', function(event) { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ });
    exportCsvBtn.addEventListener('click', function() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ });
    exportPdfBtn.addEventListener('click', function() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ });


    // =======================================================
    // === ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" (History) ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà ===
    // =======================================================
    
    // --- ELEMENT SELECTORS for new UI ---
    const historyFloatingBtn = document.getElementById('historyFloatingBtn');
    const saveFloatingBtn = document.getElementById('saveFloatingBtn');
    const historyModal = document.getElementById('historyModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const historySelector = document.getElementById('historySelector');
    const deleteHistoryBtn = document.getElementById('deleteHistoryBtn');

    const STORAGE_KEY_INDEX = 'taxAppHistoryIndex';
    const STORAGE_KEY_PREFIX = 'taxAppHistoryData_';

    // --- FUNCTIONS for History ---
    function loadHistoryDropdown() {
        historySelector.innerHTML = ''; // Clear existing options
        const index = JSON.parse(localStorage.getItem(STORAGE_KEY_INDEX)) || [];
        
        if (index.length === 0) {
            historySelector.innerHTML = '<option value="">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‚Äî</option>';
            return;
        }

        index.forEach(item => {
            const option = document.createElement('option');
            option.value = item.key;
            option.textContent = item.name;
            historySelector.appendChild(option);
        });
    }

    function saveCurrentDataToHistory() {
        const dataToSave = getTableData();
        if (dataToSave.length === 0) {
            alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (save)');
            return;
        }
        const historyName = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ:', `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH')}`);
        if (!historyName) return;

        const index = JSON.parse(localStorage.getItem(STORAGE_KEY_INDEX)) || [];
        if (index.some(item => item.name === historyName)) {
            alert('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô');
            return;
        }
        
        const newHistoryKey = `${STORAGE_KEY_PREFIX}${Date.now()}`;
        localStorage.setItem(newHistoryKey, JSON.stringify(dataToSave));
        index.push({ key: newHistoryKey, name: historyName });
        localStorage.setItem(STORAGE_KEY_INDEX, JSON.stringify(index));
        
        loadHistoryDropdown(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô modal
        alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ "${historyName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
    }

    function loadSelectedHistory() {
        const selectedKey = historySelector.value;
        if (!selectedKey) return;

        const dataString = localStorage.getItem(selectedKey);
        if (dataString) {
            const data = JSON.parse(dataString);
            populateTable(data);
            const selectedName = historySelector.options[historySelector.selectedIndex].text;
            alert(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ "${selectedName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
            historyModal.style.display = 'none'; // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î
        }
    }

    function deleteSelectedHistory() {
        const selectedKey = historySelector.value;
        if (!selectedKey) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
            return;
        }

        const selectedName = historySelector.options[historySelector.selectedIndex].text;
        if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ "${selectedName}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
            localStorage.removeItem(selectedKey);
            let index = JSON.parse(localStorage.getItem(STORAGE_KEY_INDEX)) || [];
            index = index.filter(item => item.key !== selectedKey);
            localStorage.setItem(STORAGE_KEY_INDEX, JSON.stringify(index));
            loadHistoryDropdown(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            alert(`‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ "${selectedName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        }
    }

    // --- EVENT LISTENERS for new UI ---
    saveFloatingBtn.addEventListener('click', saveCurrentDataToHistory);
    historyFloatingBtn.addEventListener('click', () => {
        loadHistoryDropdown(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î
        historyModal.style.display = 'flex';
    });
    closeModalBtn.addEventListener('click', () => {
        historyModal.style.display = 'none';
    });
    window.addEventListener('click', (event) => {
        if (event.target == historyModal) {
            historyModal.style.display = 'none';
        }
    });
    historySelector.addEventListener('change', loadSelectedHistory);
    deleteHistoryBtn.addEventListener('click', deleteSelectedHistory);
});
</script>

</body>
</html>